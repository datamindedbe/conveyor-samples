name: Pull Request CI Pipeline

on:
  push:
    branches:
      - demo/data_quality
  #pull_request:
  #  types: [synchronize, opened]

jobs:

  build:
    name: Continuous Integration of the endpoint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Display something useless as a first step
      run: |
        echo "Hello World automated from the PR pipeline !"

    - name: Setup
      working-directory: various/quality_coffee_dbt/infra
      run: |
        echo "POSTGRES_HOST=localhost" > .env
        echo "POSTGRES_PORT=5432" > .env
        echo "POSTGRES_USERNAME=postgres" >> .env
        echo "POSTGRES_PASSWORD=postgres" >> .env
        echo "POSTGRES_DB=postgres" >> .env
        docker-compose up -d
    
    - name: Install dbt
      working-directory: various/quality_coffee_dbt
      run: |
        pip install dbt-core dbt-postgres
        dbt deps

    - name: Run dbt tests
      working-directory: various/quality_coffee_dbt/dbt
      run: |
        set -a; source ../infra/.env; set +a
        dbt test --select "macros.*"
        dbt test --select "unit.*"
